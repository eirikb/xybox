xybox=function(){function a(a){var b={};a.on=function(a,c,d){2===arguments.length&&(d=c,c=1),b[a]||(b[a]=[]),b[a].push({priority:c,callback:d}),b[a].sort(function(a,b){return a.priority>b.priority})},a.trigger=function(a){var c,d=_.toArray(arguments).slice(1);return _.each(b[a],function(a){var b;b=a.callback.apply(null,d),"undefined"!=typeof b&&(c=b)}),c}}function b(a,b){function c(a){var b=h.match(/.*\//);return b=b?b[0]:"",b+=a,b.match(/\.js(on)?$/i)||(b+=".json"),b}function d(a,b){a=_.flatten([a]);var e=new createjs.LoadQueue,g=[];e.addEventListener("fileload",function(a){var b=a.result;if(h=a.item.src,b instanceof Error)throw console.log("Unable to parse",h),b;g.push(b),f.push(b)}),e.addEventListener("complete",function(){var a=_.reduce(g,function(a,b){return _.flatten([b.includes]).length+a},0);_.each(g,function(e){e.includes?(e.includes=_.map(e.includes,c),d(e.includes,b)):(a--,0===a&&b())})}),e.loadManifest(a)}function e(a,d){var e=new createjs.LoadQueue,f=_.compact(_.toArray(a.defs).concat(a.items)),g=[];b.assets={},e.addEventListener("fileload",function(a){b.assets[a.item.id]=a.result,"js"===a.item.ext&&document.body.appendChild(a.result)}),e.addEventListener("complete",d),_.each(f,function(a){var b=a.code;b&&(b=b.match(/(.*) /)),b&&g.push(c(b[1])),_.each(a.graphics,function(a){var b=a.image;b&&g.push(b)})}),e.loadManifest(g)}var f,h,i=this;i.init=function(a,c){f=[],d(a,function(){var a=f[0];_.each(f.slice(1),function(b){g.deepDefaults(a,b)}),b.items=a.items,b.defs=a.defs,e(a,c)})}}function c(a){function b(b,c,d){var e=c.m_fixtureA.m_body.object,f=c.m_fixtureB.m_body.object;a.trigger(b,e,f,d)}function c(a,b){a.Step(b,b*g,b*h)}var d=this,e=trolley.init();a.world=e;var f=Date.now(),g=300,h=200,i=[];a.pos=function(b){var c;return b.body?(c=trolley.pos(b.body),{x:c.x*a.scale,y:a.height-c.y*a.scale-b.body.height*a.scale}):b},d.init=function(){var a={x:0,y:0};e.SetGravity(new b2Vec2(a.x,a.y))},d.createItem=function(a){a.body&&(a.body=trolley.build(a.body).create()[0],a.body&&(a.body.object=a))},d.overlapping=function(a){function b(a){return a!==d&&a.GetAABB().TestOverlap(d.GetAABB())&&c.push(a.GetBody()),!0}for(var c=[],d=a.GetFixtureList();null!==d;)physics.world.QueryAABB(b,d.GetAABB()),d=d.GetNext();return c},d.collide=function(b,c){a.on("collide",function(a,d){if(a&&d){var e=a.def===b?a:d;e.def===b&&(e===d&&(d=a),c(e,d))}})};var j=new b2ContactListener;return j.BeginContact=function(a){b("collide",a),b("begincontact",a)},j.EndContact=function(a){b("endcontact",a)},j.PostSolve=function(a,c){b("postsolve",a,c)},j.PreSolve=function(a,c){b("presolve",a,c)},e.SetContactListener(j),e.SetContactFilter({ShouldCollide:function(b,c){var d,e;return d=b.m_body.object,e=c.m_body.object,a.trigger("shouldcollide",d,e)}}),a.on("tick",-1,function(){_.each(i,function(a){e.DestroyBody(a)}),i=[];var b=(new Date).getTime(),d=(b-f)/1e3;f=b,d>10&&(d=1/a.fps),c(e,d)}),d}function d(a,b){function c(b){var c=a.pos(b);_.each(b.graphics,function(a){a.x=c.x,a.y=c.y,a.paddX&&(a.x+=a.paddX),a.paddY&&(a.y+=a.paddY),b.body&&(a.rotation=-(180*b.body.GetAngle()/Math.PI))})}function d(c){var d=[];_.each(c.graphics,function(f){if(!f.image)throw new Error("Missing graphics image: "+c.def);var g=b.assets[f.image];if(!g)throw new Error("Unknown graphics image: "+f.image);var h,i,j;if(f.animations){i=f.width||f.frames.width,j=f.height||f.frames.height,c.body&&(i=c.body.width*a.scale,j=c.body.height*a.scale),f.images=[g.src];var k=new createjs.SpriteSheet(f);h=new createjs.BitmapAnimation(k),c.animation&&(f.animation=c.animation),f.animation||(f.animation="default");var l=!!f.animations[f.animation],m="gotoAnd"+(l?"Play":"Stop");h[m](f.animation),h.width=i,h.height=j,h.scaleX=i/f.frames.width,h.scaleY=j/f.frames.height}else{i=f.width||g.width,j=f.height||g.height,c.body&&(i=c.body.width*a.scale,j=c.body.height*a.scale),h=new createjs.Shape;var n=h.graphics;n.beginBitmapFill(g),"repeat"===f.type?n.drawRect(0,0,i,j):(n.drawRect(0,0,g.width,g.height),h.scaleX=i/g.width,h.scaleY=j/g.height),h.width=i,h.height=j}c.rotation&&(h.rotation=c.rotation),h.paddX=f.paddX,h.paddY=f.paddY,h.regX=h.w/2,h.regY=h.h/2,h.loop=f.loop,f.zindex?e.addChildAt(h,f.zindex):e.addChild(h),d.push(h),f.name&&(d[f.name]=h)}),c.graphics=d}var e,f=this;f.createItem=function(b){d(b),_.each(b.graphics,function(c){c.loop&&(c.onAnimationEnd=function(){return c.loop--,0===c.loop?(b.body?a.destroyItem(b):e.removeChild(c),void 0):(c.gotoAndPlay(c.currentAnimation),void 0)})}),c(b)},f.init=function(){a.width=a.canvas.width,a.height=a.canvas.height,a.center={x:a.width/2,y:a.height/2},e=a.stage=new createjs.Stage(a.canvas),e.onMouseMove=function(b){a.trigger("mouseMove",b)},e.onMouseDown=function(b){a.trigger("mouseDown",b)},e.onMouseUp=function(b){a.trigger("mouseUp",b)}},f.itemDestroy=function(a){_.each(a.graphics,function(a){e.removeChild(a)})},a.on("tick",2,function(){_.each(a.actives,c);for(var b=0;b<e.getNumChildren();b++){var d=e.getChildAt(b),f=d.x+e.x,g=d.y+e.y;d.visible=f>=0&&f<a.canvas.width+d.width&&g>=0&&g<a.canvas.height+d.height}e.update()})}function e(){function e(){createjs.Ticker.addListener(function(){h.trigger("tick")}),h.trigger("game:start")}var h=this,i={};h.version=f.version,h.items=[],h.actives=[],h.scale=16,i.keys=new Kibo,i.events=new a(h,i),i.graphics=new d(h,i),i.preload=new b(h,i),i.physics=new c(h,i),h.createItem=function(a){var b;if(a.def&&(b=i.defs[a.def]),b&&g.deepDefaults(a,b),a.name&&(h[a.name]=a),h.items.push(a),b&&b.body&&!b.body.isStatic&&h.actives.push(a),i.physics.createItem(a),i.graphics.createItem(a),a.code){var c=a.code.match(/ (.*)$/);c&&c.length>1&&window[c[1]](a,h)}return a},h.destroyItem=function(a){h.items=_.without(h.items,a)},h.overlapping=function(a){var b=physics.overlapping(a.body);return _.chain(b).compact().map(function(a){return a.item}).value()},h.init=function(a,b){h.canvas=document.getElementById(a),i.graphics.init(),i.physics.init(),i.preload.init(b,function(){_.each(i.items,function(a){h.createItem(a)}),e()})}}var f={name:"xybox",author:{name:"Eirik Brandtz√¶g"},version:"1.0.2",devDependencies:{grunt:"~0.4.1","grunt-contrib":"~0.7.0"}},g={deepDefaults:function(a,b){_.isObject(a)&&_.isObject(b)&&(_.defaults(a,b),_.each(a,function(a,c){g.deepDefaults(a,b[c])}))}};return{Game:e,version:f.version}}();