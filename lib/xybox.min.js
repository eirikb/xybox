xybox=function(){function a(a){var b={};a.on=function(a,c,d){2===arguments.length&&(d=c,c=1),b[a]||(b[a]=[]),b[a].push({priority:c,callback:d}),b[a].sort(function(a,b){return a.priority>b.priority})},a.trigger=function(a){var c,d=_.toArray(arguments).slice(1);return _.each(b[a],function(a){var b;b=a.callback.apply(null,d),"undefined"!=typeof b&&(c=b)}),c}}function b(a){function b(a){var b=f.match(/.*\//);return b=b?b[0]:"",b+=a,b.match(/\.js(on)?$/i)||(b+=".json"),b}function c(a,d){a=_.flatten([a]);var g=new createjs.LoadQueue,h=[];g.addEventListener("fileload",function(a){var b=a.result;if(f=a.item.src,b instanceof Error)throw console.log("Unable to parse",f),b;h.push(b),e.push(b)}),g.addEventListener("complete",function(){var a=_.reduce(h,function(a,b){return _.flatten([b.includes]).length+a},0);_.each(h,function(e){e.includes?(e.includes=_.map(e.includes,b),c(e.includes,d)):(a--,0===a&&d())})}),g.loadManifest(a)}function d(c,d){var e=new createjs.LoadQueue,f=_.compact(_.toArray(c.defs).concat(c.items)),g=[];a.assets={},e.addEventListener("fileload",function(b){a.assets[b.item.id]=b.result,"js"===b.item.ext&&document.body.appendChild(b.result)}),e.addEventListener("complete",d),_.each(f,function(a){var c=a.code;c&&(c=c.match(/(.*) /)),c&&g.push(b(c[1])),_.each(a.graphics,function(a){var b=a.image;b&&g.push(b)})}),e.loadManifest(g)}var e,f,h=this;h.init=function(b,f){e=[],c(b,function(){var b=e[0];_.each(e.slice(1),function(a){g.deepDefaults(b,a)}),a.items=b.items,a.defs=b.defs,d(b,f)})}}function c(a){function b(b,c,d){var e=c.m_fixtureA.m_body.object,f=c.m_fixtureB.m_body.object;a.trigger(b,e,f,d)}function c(a,b){a.Step(b,b*h,b*i)}var d=this,e=new Trolley,f=e.world;a.world=f;var g=Date.now(),h=300,i=200,j=[];a.pos=function(b){var c;return b.body?(c=e.pos(b.body),{x:c.x*a.scale,y:a.height-c.y*a.scale-b.body.height*a.scale}):b},d.init=function(){var a={x:0,y:0};f.SetGravity(new b2Vec2(a.x,a.y))},d.createItem=function(a){a.body&&(a.body=e.build(a.body).create()[0],a.body&&(a.body.object=a))},d.overlapping=function(a){function b(a){return a!==d&&a.GetAABB().TestOverlap(d.GetAABB())&&c.push(a.GetBody()),!0}for(var c=[],d=a.GetFixtureList();null!==d;)physics.world.QueryAABB(b,d.GetAABB()),d=d.GetNext();return c},d.collide=function(b,c){a.on("collide",function(a,d){if(a&&d){var e=a.def===b?a:d;e.def===b&&(e===d&&(d=a),c(e,d))}})};var k=new b2ContactListener;return k.BeginContact=function(a){b("collide",a),b("begincontact",a)},k.EndContact=function(a){b("endcontact",a)},k.PostSolve=function(a,c){b("postsolve",a,c)},k.PreSolve=function(a,c){b("presolve",a,c)},f.SetContactListener(k),f.SetContactFilter({ShouldCollide:function(b,c){var d,e;return d=b.m_body.object,e=c.m_body.object,a.trigger("shouldcollide",d,e)}}),a.on("tick",-1,function(){_.each(j,function(a){f.DestroyBody(a)}),j=[];var b=(new Date).getTime(),d=(b-g)/1e3;g=b,d>10&&(d=1/a.fps),c(f,d)}),d}function d(a){function b(b){var c=a.pos(b);_.each(b.graphics,function(a){a.x=c.x,a.y=c.y,a.paddX&&(a.x+=a.paddX),a.paddY&&(a.y+=a.paddY),b.body&&(a.rotation=-(180*b.body.GetAngle()/Math.PI))})}function c(b){var c=[];_.each(b.graphics,function(e){if(!e.image)throw new Error("Missing graphics image: "+b.def);var f=a.assets[e.image];if(!f)throw new Error("Unknown graphics image: "+e.image);var g,h,i;if(e.animations){h=e.width||e.frames.width,i=e.height||e.frames.height,b.body&&(h=b.body.width*a.scale,i=b.body.height*a.scale),e.images=[f.src];var j=new createjs.SpriteSheet(e);g=new createjs.BitmapAnimation(j),b.animation&&(e.animation=b.animation),e.animation||(e.animation="default");var k=!!e.animations[e.animation],l="gotoAnd"+(k?"Play":"Stop");g[l](e.animation),g.width=h,g.height=i,g.scaleX=h/e.frames.width,g.scaleY=i/e.frames.height}else{h=e.width||f.width,i=e.height||f.height,b.body&&(h=b.body.width*a.scale,i=b.body.height*a.scale),g=new createjs.Shape;var m=g.graphics;m.beginBitmapFill(f),"repeat"===e.type?m.drawRect(0,0,h,i):(m.drawRect(0,0,f.width,f.height),g.scaleX=h/f.width,g.scaleY=i/f.height),g.width=h,g.height=i}b.rotation&&(g.rotation=b.rotation),g.paddX=e.paddX,g.paddY=e.paddY,g.regX=g.w/2,g.regY=g.h/2,g.loop=e.loop,e.zindex?d.addChildAt(g,e.zindex):d.addChild(g),c.push(g),e.name&&(c[e.name]=g)}),b.graphics=c}var d,e=this;e.createItem=function(e){c(e),_.each(e.graphics,function(b){b.loop&&(b.onAnimationEnd=function(){return b.loop--,0===b.loop?(e.body?a.destroyItem(e):d.removeChild(b),void 0):(b.gotoAndPlay(b.currentAnimation),void 0)})}),b(e)},e.init=function(){a.width=a.canvas.width,a.height=a.canvas.height,a.center={x:a.width/2,y:a.height/2},d=a.stage=new createjs.Stage(a.canvas),d.onMouseMove=function(b){a.trigger("mouseMove",b)},d.onMouseDown=function(b){a.trigger("mouseDown",b)},d.onMouseUp=function(b){a.trigger("mouseUp",b)}},e.itemDestroy=function(a){_.each(a.graphics,function(a){d.removeChild(a)})},a.on("tick",2,function(){_.each(a.actives,b);for(var c=0;c<d.getNumChildren();c++){var e=d.getChildAt(c),f=e.x+d.x,g=e.y+d.y;e.visible=f>=0&&f<a.canvas.width+e.width&&g>=0&&g<a.canvas.height+e.height}d.update()})}function e(){function e(){createjs.Ticker.addListener(function(){i.trigger("tick")}),i.trigger("game:start")}var h=this,i={};h.version=f.version,i.items=[],i.actives=[],i.scale=16,i.keys=new Kibo,i.events=new a(i),i.graphics=new d(i),i.preload=new b(i),i.physics=new c(i),h.on=i.on,h.trigger=i.trigger,h.createItem=function(a){var b;if(a.def&&(b=i.defs[a.def]),b&&g.deepDefaults(a,b),a.name&&(i[a.name]=a),i.items.push(a),i.physics.createItem(a),i.graphics.createItem(a),a&&a.body&&!a.body.isStatic&&i.actives.push(a),a.code){var c=a.code.match(/ (.*)$/);c&&c.length>1&&window[c[1]](a,h)}return a},h.destroyItem=function(a){i.items=_.without(i.items,a)},h.overlapping=function(a){var b=physics.overlapping(a.body);return _.chain(b).compact().map(function(a){return a.item}).value()},h.init=function(a,b){i.canvas=document.getElementById(a),i.graphics.init(),i.physics.init(),i.preload.init(b,function(){_.each(i.items,function(a){h.createItem(a)}),e()})}}var f={name:"xybox",author:{name:"Eirik Brandtz√¶g"},version:"1.0.2",devDependencies:{grunt:"~0.4.1","grunt-contrib":"~0.7.0"}},g={deepDefaults:function(a,b){_.isObject(a)&&_.isObject(b)&&(_.defaults(a,b),_.each(a,function(a,c){g.deepDefaults(a,b[c])}))}};return{Game:e,version:f.version}}();